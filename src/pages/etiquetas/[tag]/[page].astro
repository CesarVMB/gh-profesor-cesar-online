---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import PostsList from '../../../components/PostsList.astro';

import { getCollection } from 'astro:content';

export async function getStaticPaths({ paginate }) {
  const posts = await getCollection('publicaciones');

  // üîπ Obtener todas las etiquetas √∫nicas
  const tags = Array.from(
    new Set(
      posts.flatMap(post => post.data.tags ?? [])
    )
  );

  // üîπ Crear p√°ginas paginadas por etiqueta
  return tags.flatMap(tag =>
    paginate(
      posts
        // filtrar por etiqueta
        .filter(post => post.data.tags?.includes(tag))
        // ‚úÖ ORDEN CORRECTO: m√°s recientes primero
        .sort(
          (a, b) =>
            new Date(b.data.pubDate).getTime() -
            new Date(a.data.pubDate).getTime()
        ),
      {
        params: { tag },
        pageSize: 6,
      }
    )
  );
}

// --------------------
// Props y params
// --------------------
const { tag } = Astro.params;
const { page } = Astro.props;

// TOTAL REAL de art√≠culos (no solo de la p√°gina)
const totalArticles = page.total;

// pluralizaci√≥n simple en espa√±ol
const articleLabel = totalArticles === 1 ? 'art√≠culo' : 'art√≠culos';

// --------------------
// SEO
// --------------------
const pageTitle = `Etiqueta: ${tag} (${totalArticles} ${articleLabel})`;
const pageDescription = `Publicaciones etiquetadas con ${tag}`;
---

<BaseLayout pageTitle={pageTitle} pageDescription={pageDescription}>

  <Breadcrumbs
    extraItems={[
      { label: 'Etiquetas', url: '/etiquetas/' },
      { label: tag },
    ]}
  />

  <h1 class="mb-4">
    <span>{pageTitle}</span>
  </h1>

  <PostsList page={page} />

</BaseLayout>

